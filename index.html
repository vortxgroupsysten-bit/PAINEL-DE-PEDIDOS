<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o & Financeiro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-panel: #1e1e1e; --bg-sidebar: #181818;
            --primary: #ff9f43; --success: #1dd1a1; --danger: #ff6b6b; --info: #54a0ff;
            --text-main: #f1f1f1; --text-dim: #a5a5a5; --border: #333;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-btn { background: transparent; border: none; color: var(--text-dim); padding: 15px 20px; text-align: left; font-size: 1rem; cursor: pointer; border-radius: 8px; transition: 0.3s; margin-bottom: 10px; width: 100%; font-weight: 500; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-btn.active { background: var(--primary); color: #fff; box-shadow: 0 4px 15px rgba(255, 159, 67, 0.3); }

        /* Main */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .header-title { font-size: 1.8rem; font-weight: 600; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 15px; display: flex; justify-content: space-between; }
        .hidden { display: none; }
        .empty-state { text-align: center; padding: 40px; border: 2px dashed #333; border-radius: 10px; color: var(--text-dim); }

        /* Grids e Cards */
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        
        /* Estilos Espec√≠ficos Financeiro */
        .finance-card { display: flex; align-items: center; justify-content: space-between; border-left: 5px solid var(--success); }
        .waiter-name { font-size: 1.2rem; font-weight: bold; }
        .waiter-total { font-size: 1.5rem; color: var(--success); font-weight: 700; }
        .sales-count { font-size: 0.8rem; color: var(--text-dim); }
        .total-day-box { background: #252525; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px solid var(--success); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-panel); width: 450px; border-radius: 15px; border: 1px solid var(--border); overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 50vh; overflow-y: auto; }
        .modal-footer { padding: 20px; background: #252525; }
        .receipt-item { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-pay { background: var(--success); }
        .btn-pay:hover { filter: brightness(1.1); }
        .btn-close { background: transparent; color: var(--text-dim); }

        /* Estilos Cozinha/Mesas (Simplificado para caber) */
        .ticket-card { background: var(--bg-panel); border-radius: 10px; border-top: 5px solid var(--primary); padding: 15px; margin-bottom: 15px; }
        .btn-deliver { background: transparent; border: 1px solid var(--success); color: var(--success); width: 100%; padding: 8px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .btn-deliver:hover { background: var(--success); color: white; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand">üöÄ SysRest</div>
        <button class="nav-btn active" id="btn-kitchen" onclick="navigate('kitchen')">üë®‚Äçüç≥ Cozinha</button>
        <button class="nav-btn" id="btn-tables" onclick="navigate('tables')">üí∞ Mesas / Caixa</button>
        <button class="nav-btn" id="btn-finance" onclick="navigate('finance')">üí≤ Financeiro</button>
    </nav>

    <main class="main-content">
        <div id="view-kitchen">
            <div class="header-title"><span>Fila de Pedidos</span></div>
            <div id="kitchen-container" class="grid-layout"></div>
        </div>

        <div id="view-tables" class="hidden">
            <div class="header-title"><span>Contas Abertas</span></div>
            <div id="tables-container" class="grid-layout"></div>
        </div>

        <div id="view-finance" class="hidden">
            <div class="header-title">
                <span>Vendas do Dia (Por Gar√ßom)</span>
                <button onclick="clearHistory()" style="background:#333; border:none; color:white; padding:5px 10px; cursor:pointer; border-radius:4px; font-size:0.8rem;">Limpar Dia</button>
            </div>
            <div class="total-day-box">
                <span style="display:block; color:var(--text-dim);">Faturamento Total Hoje</span>
                <span style="font-size: 2.5rem; font-weight: bold; color: var(--success);" id="grand-total">R$ 0.00</span>
            </div>
            <div id="finance-container" class="grid-layout"></div>
        </div>
    </main>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Fechar Conta</h3>
                <button class="btn-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modal-list"></div>
            <div class="modal-footer">
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:bold; margin-bottom:10px;">
                    <span>Total:</span> <span id="modal-total">R$ 0.00</span>
                </div>
                <button class="btn-action btn-pay" onclick="payBill()">üí∏ Confirmar Pagamento</button>
            </div>
        </div>
    </div>

    <script>
        // Navega√ß√£o
        function navigate(page) {
            ['kitchen', 'tables', 'finance'].forEach(p => {
                document.getElementById(`view-${p}`).classList.add('hidden');
                document.getElementById(`btn-${p}`).classList.remove('active');
            });
            document.getElementById(`view-${page}`).classList.remove('hidden');
            document.getElementById(`btn-${page}`).classList.add('active');
            
            if(page === 'kitchen') renderKitchen();
            if(page === 'tables') renderTables();
            if(page === 'finance') renderFinance();
        }

        // --- L√ìGICA COZINHA ---
        function renderKitchen() {
            const container = document.getElementById('kitchen-container');
            const orders = JSON.parse(localStorage.getItem('restaurantOrders')) || [];
            container.innerHTML = orders.length ? '' : '<div class="empty-state">Sem pedidos pendentes.</div>';
            
            orders.forEach((order, idx) => {
                let itemsHtml = order.items.map(i => `<li>${i.qty}x ${i.name}</li>`).join('');
                container.innerHTML += `
                    <div class="ticket-card">
                        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
                            <span>Mesa ${order.table}</span> <small>${order.time}</small>
                        </div>
                        <div style="background:#333; color:var(--primary); padding:2px 8px; border-radius:4px; font-size:0.8rem; display:inline-block; margin-bottom:10px;">Gar√ßom: ${order.waiter}</div>
                        <ul style="padding-left:20px; margin:0;">${itemsHtml}</ul>
                        <button class="btn-deliver" onclick="deliverOrder(${idx})">‚úÖ Pronto</button>
                    </div>`;
            });
        }

        function deliverOrder(idx) {
            let orders = JSON.parse(localStorage.getItem('restaurantOrders'));
            let order = orders[idx];
            
            // Notifica
            let notifs = JSON.parse(localStorage.getItem('restaurantNotifications')) || [];
            notifs.push({ id: Date.now(), msg: `Mesa ${order.table} pronto!`, waiter: order.waiter });
            localStorage.setItem('restaurantNotifications', JSON.stringify(notifs));

            // Salva na mesa
            let tabs = JSON.parse(localStorage.getItem('restaurantTabs')) || {};
            if(!tabs[order.table]) tabs[order.table] = [];
            const itemsTagged = order.items.map(i => ({...i, waiter: order.waiter}));
            tabs[order.table].push(...itemsTagged);
            localStorage.setItem('restaurantTabs', JSON.stringify(tabs));

            // Remove e atualiza
            orders.splice(idx, 1);
            localStorage.setItem('restaurantOrders', JSON.stringify(orders));
            renderKitchen();
        }

        // --- L√ìGICA MESAS ---
        function renderTables() {
            const container = document.getElementById('tables-container');
            const tabs = JSON.parse(localStorage.getItem('restaurantTabs')) || {};
            const keys = Object.keys(tabs);
            container.innerHTML = keys.length ? '' : '<div class="empty-state">Nenhuma conta aberta.</div>';

            keys.forEach(t => {
                let total = tabs[t].reduce((acc, i) => acc + (i.price * i.qty), 0);
                container.innerHTML += `
                    <div class="card">
                        <h2 style="margin:0 0 10px 0;">Mesa ${t}</h2>
                        <div style="color:var(--success); font-size:1.5rem; font-weight:bold;">R$ ${total.toFixed(2)}</div>
                        <button class="btn-action btn-pay" style="background:var(--info);" onclick="openModal('${t}')">Ver Conta</button>
                    </div>`;
            });
        }

        // --- L√ìGICA FINANCEIRO & FECHAMENTO ---
        let activeTable = null;

        function openModal(table) {
            activeTable = table;
            const tabs = JSON.parse(localStorage.getItem('restaurantTabs'));
            const items = tabs[table];
            const list = document.getElementById('modal-list');
            let total = 0; list.innerHTML = '';

            items.forEach(i => {
                total += i.price * i.qty;
                list.innerHTML += `<div class="receipt-item"><span>${i.qty}x ${i.name} <br><small style="color:gray">${i.waiter || 'Sistema'}</small></span> <span>R$ ${(i.price*i.qty).toFixed(2)}</span></div>`;
            });
            document.getElementById('modal-total').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function payBill() {
            if(!confirm("Confirmar pagamento?")) return;

            // 1. Processar Hist√≥rico de Vendas
            const tabs = JSON.parse(localStorage.getItem('restaurantTabs'));
            const items = tabs[activeTable];
            const history = JSON.parse(localStorage.getItem('restaurantSalesHistory')) || [];

            // Adiciona cada item ao hist√≥rico
            items.forEach(item => {
                history.push({
                    waiter: item.waiter || 'Outros',
                    amount: item.price * item.qty,
                    item: item.name,
                    time: new Date().toLocaleTimeString()
                });
            });
            localStorage.setItem('restaurantSalesHistory', JSON.stringify(history));

            // 2. Apagar Mesa
            delete tabs[activeTable];
            localStorage.setItem('restaurantTabs', JSON.stringify(tabs));

            closeModal();
            navigate('tables'); // Recarrega tela
            alert("Conta fechada e vendas registradas!");
        }

        function renderFinance() {
            const container = document.getElementById('finance-container');
            const history = JSON.parse(localStorage.getItem('restaurantSalesHistory')) || [];
            
            // Agrupar por gar√ßom
            const salesByWaiter = {};
            let grandTotal = 0;

            history.forEach(sale => {
                if(!salesByWaiter[sale.waiter]) salesByWaiter[sale.waiter] = 0;
                salesByWaiter[sale.waiter] += sale.amount;
                grandTotal += sale.amount;
            });

            document.getElementById('grand-total').innerText = `R$ ${grandTotal.toFixed(2)}`;
            container.innerHTML = Object.keys(salesByWaiter).length ? '' : '<div class="empty-state">Nenhuma venda registrada hoje.</div>';

            // Ordenar quem vendeu mais
            const sortedWaiters = Object.entries(salesByWaiter).sort((a,b) => b[1] - a[1]);

            sortedWaiters.forEach(([waiter, total]) => {
                container.innerHTML += `
                    <div class="card finance-card">
                        <div>
                            <div class="waiter-name">${waiter}</div>
                            <div class="sales-count">Vendas acumuladas</div>
                        </div>
                        <div class="waiter-total">R$ ${total.toFixed(2)}</div>
                    </div>`;
            });
        }

        function clearHistory() {
            if(confirm("Deseja apagar o hist√≥rico de vendas de hoje?")) {
                localStorage.removeItem('restaurantSalesHistory');
                renderFinance();
            }
        }

        setInterval(() => {
            if(!document.getElementById('view-kitchen').classList.contains('hidden')) renderKitchen();
        }, 5000);
        
        renderKitchen();
    </script>
</body>
</html>
